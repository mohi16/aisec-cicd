# =============================================================================
# BASELINE PIPELINE
# Includes: formatting check, compilation with lint warnings, unit tests
# Does NOT include: any security scanning tools
# =============================================================================
name: Baseline Pipeline

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Format check (Spotless)
  # ---------------------------------------------------------------------------
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Check formatting with Spotless
        run: mvn spotless:check -B -q

  # ---------------------------------------------------------------------------
  # Job 2: Compile with lint warnings
  # ---------------------------------------------------------------------------
  compile:
    name: Compile & Lint
    runs-on: ubuntu-latest
    needs: format-check
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Compile with lint warnings
        run: mvn compile -B -Xlint:all

  # ---------------------------------------------------------------------------
  # Job 3: Unit tests
  # ---------------------------------------------------------------------------
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: compile
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests
        run: mvn test -B

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: baseline-test-reports
          path: target/surefire-reports/
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Job 4: Record pipeline metrics
  # ---------------------------------------------------------------------------
  record-metrics:
    name: Record Pipeline Metrics
    runs-on: ubuntu-latest
    needs: [format-check, compile, test]
    if: always()
    steps:
      - name: Collect pipeline metadata
        run: |
          echo "## Baseline Pipeline Metrics" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pipeline | Baseline |" >> $GITHUB_STEP_SUMMARY
          echo "| PR Number | ${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run Attempt | ${{ github.run_attempt }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered at | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Format Check | ${{ needs.format-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compile | ${{ needs.compile.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
